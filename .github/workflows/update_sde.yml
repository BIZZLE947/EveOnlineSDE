name: Update EVE SDE Data

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * 2' # Tuesdays at 08:00 UTC

permissions:
  contents: write

jobs:
  convert-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Download & Unzip SDE
        run: |
          echo "Downloading SDE..."
          wget -O sde.zip https://eve-static-data-export.s3-eu-west-1.amazonaws.com/tranquility/sde.zip
          echo "Unzipping..."
          unzip -q sde.zip -d sde

      - name: Install Dependencies
        run: |
          pip install pandas pyyaml openpyxl tqdm

      - name: Run Converter
        run: |
          # Ensure filename matches your repository file exactly!
          python "YAML Converter.py" "sde" --format csv

      - name: Prepare Assets
        run: |
          # 1. Move the Schema file OUT of the folder so it doesn't get zipped
          mv sde/converted_output/schema_map.json schema_map.json
          
          # 2. Zip the remaining CSV files
          cd sde/converted_output
          zip -r ../../eve_sde_csv.zip .
          cd ../..

      - name: Get Date
        id: date
        run: echo "today=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: data-${{ steps.date.outputs.today }}
          name: EVE SDE Data (${{ steps.date.outputs.today }})
          body: |
            Automated conversion of the EVE Online Static Data Export.
            - **eve_sde_csv.zip**: The converted CSV data files.
            - **schema_map.json**: A roadmap of columns available in every file.
          files: |
            eve_sde_csv.zip
            schema_map.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}