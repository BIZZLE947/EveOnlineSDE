name: Update EVE SDE Data

on:
  workflow_dispatch:       # Manual run button
  schedule:
    - cron: '0 */6 * * *'  # Run every 6 hours

permissions:
  contents: write

jobs:
  check-and-process:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # STEP 1: Check SDE Version & Server Date
      # ---------------------------------------------------------
      - name: Check SDE Build Version
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Resolve the Redirect URL to get the specific file path
          REDIRECT_URL=$(curl -sIL -o /dev/null -w '%{url_effective}' https://developers.eveonline.com/static-data/eve-online-static-data-latest-yaml.zip)
          
          # 2. Extract Build Number from URL
          if [[ $REDIRECT_URL =~ static-data-([0-9]+)-yaml ]]; then
            BUILD_NUM="${BASH_REMATCH[1]}"
          else
            # Fallback if URL format changes
            BUILD_NUM=$(date +'%Y%m%d')
          fi
          
          # 3. Extract the Official 'Last-Modified' Date from the Server Headers
          # This gets the date CCP uploaded the file, not today's date.
          SERVER_HEADER=$(curl -sI "$REDIRECT_URL" | grep -i "last-modified" | cut -d' ' -f2-)
          
          # Convert "Mon, 27 Nov 2025..." to "2025-11-27"
          if [ -n "$SERVER_HEADER" ]; then
            OFFICIAL_DATE=$(date -d "$SERVER_HEADER" +'%Y-%m-%d')
          else
            OFFICIAL_DATE=$(date +'%Y-%m-%d') # Fallback to today
          fi
          
          TAG="sde-$BUILD_NUM"
          
          echo "ðŸ”¹ Detected Build: $BUILD_NUM"
          echo "ðŸ”¹ Official Date: $OFFICIAL_DATE"
          
          # 4. Check if release exists
          if gh release view "$TAG" > /dev/null 2>&1; then
            echo "âœ… Release $TAG already exists."
            echo "should_run=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸš€ New SDE version detected!"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "release_tag=$TAG" >> $GITHUB_OUTPUT
            echo "build_num=$BUILD_NUM" >> $GITHUB_OUTPUT
            echo "sde_date=$OFFICIAL_DATE" >> $GITHUB_OUTPUT
          fi

      # ---------------------------------------------------------
      # STEP 2: Process (Only runs if new version found)
      # ---------------------------------------------------------
      
      - name: Set up Python
        if: steps.check.outputs.should_run == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Download & Unzip SDE
        if: steps.check.outputs.should_run == 'true'
        run: |
          echo "Downloading Build ${{ steps.check.outputs.build_num }}..."
          wget -O sde.zip https://developers.eveonline.com/static-data/eve-online-static-data-latest-yaml.zip
          unzip -q sde.zip -d sde

      - name: Install Dependencies
        if: steps.check.outputs.should_run == 'true'
        run: |
          pip install pandas pyyaml openpyxl tqdm

      - name: Run Converter
        if: steps.check.outputs.should_run == 'true'
        run: |
          python "YAML Converter.py" "sde" --format csv

      - name: Prepare Assets
        if: steps.check.outputs.should_run == 'true'
        run: |
          mv sde/converted_output/schema_map.json schema_map.json
          cd sde/converted_output
          zip -r ../../eve_sde_csv.zip .
          cd ../..

      - name: Create Release
        if: steps.check.outputs.should_run == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.check.outputs.release_tag }}
          # UPDATED TITLE FORMAT
          name: Build ${{ steps.check.outputs.build_num }} | ${{ steps.check.outputs.sde_date }}
          body: |
            **Official Build:** ${{ steps.check.outputs.build_num }}
            **Official Release Date:** ${{ steps.check.outputs.sde_date }}
            
            Automated conversion of the EVE Online Static Data Export.
          files: |
            eve_sde_csv.zip
            schema_map.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}