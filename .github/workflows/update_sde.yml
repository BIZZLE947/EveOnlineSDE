name: Update EVE SDE Data

on:
  workflow_dispatch:       # Manual run button
  schedule:
    - cron: '0 */6 * * *'  # Run every 6 hours (Checks are cheap now!)

permissions:
  contents: write

jobs:
  check-and-process:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # STEP 1: Check the SDE Server for the latest version date
      # ---------------------------------------------------------
      - name: Check SDE Version
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Get the HTTP Header 'Last-Modified' from the EVE Server
          # Example Output: "Mon, 25 Nov 2024 14:03:12 GMT"
          RAW_DATE=$(curl -sI https://eve-static-data-export.s3-eu-west-1.amazonaws.com/tranquility/sde.zip | grep -i "last-modified" | cut -d' ' -f2-)
          
          # 2. Convert that date to a clean tag format: YYYYMMDD
          # Example Output: 20241125
          SDE_DATE=$(date -d "$RAW_DATE" +'%Y%m%d')
          TAG="sde-$SDE_DATE"
          
          echo "ðŸ”¹ Official SDE Date: $SDE_DATE"
          echo "ðŸ”¹ Proposed Tag: $TAG"
          
          # 3. Check if this Release already exists in your repo
          if gh release view "$TAG" > /dev/null 2>&1; then
            echo "âœ… Release $TAG already exists."
            echo "should_run=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸš€ New SDE version detected! Proceeding..."
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "release_tag=$TAG" >> $GITHUB_OUTPUT
            echo "sde_date=$SDE_DATE" >> $GITHUB_OUTPUT
          fi

      # ---------------------------------------------------------
      # STEP 2: The Heavy Lifting (Only runs if new version found)
      # ---------------------------------------------------------
      
      - name: Set up Python
        if: steps.check.outputs.should_run == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Download & Unzip SDE
        if: steps.check.outputs.should_run == 'true'
        run: |
          echo "Downloading SDE..."
          wget -O sde.zip https://eve-static-data-export.s3-eu-west-1.amazonaws.com/tranquility/sde.zip
          echo "Unzipping..."
          unzip -q sde.zip -d sde

      - name: Install Dependencies
        if: steps.check.outputs.should_run == 'true'
        run: |
          pip install pandas pyyaml openpyxl tqdm

      - name: Run Converter
        if: steps.check.outputs.should_run == 'true'
        run: |
          python "YAML Converter.py" "sde" --format csv

      - name: Prepare Assets
        if: steps.check.outputs.should_run == 'true'
        run: |
          mv sde/converted_output/schema_map.json schema_map.json
          cd sde/converted_output
          zip -r ../../eve_sde_csv.zip .
          cd ../..

      - name: Create Release
        if: steps.check.outputs.should_run == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.check.outputs.release_tag }}
          name: EVE SDE ${{ steps.check.outputs.sde_date }}
          body: |
            **Official SDE Date:** ${{ steps.check.outputs.sde_date }}
            
            Automated conversion of the EVE Online Static Data Export.
            - **eve_sde_csv.zip**: The converted CSV data files.
            - **schema_map.json**: Column definitions.
          files: |
            eve_sde_csv.zip
            schema_map.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}